# ChatPDF in Snowflake - アーキテクチャ改善案

## 改善されたアプリケーション構造

```
snowflake_chatpdf/
├── streamlit_app.py                  # メインアプリケーションエントリーポイント
├── config.py                         # アプリケーション設定と定数
├── utils/
│   ├── __init__.py
│   ├── pdf_utils.py                  # PDF処理ユーティリティ  
│   ├── snowflake_utils.py            # Snowflake接続と操作
│   ├── vector_utils.py               # ベクトル操作と類似度計算
│   └── export_utils.py               # エクスポート機能
├── components/
│   ├── __init__.py
│   ├── sidebar.py                    # サイドバーコンポーネント
│   ├── pdf_viewer.py                 # PDF表示コンポーネント
│   ├── search_interface.py           # 検索インターフェースと結果表示
│   ├── chat_interface.py             # チャットインターフェース
│   └── analytics_panel.py            # 分析パネル
├── services/
│   ├── __init__.py
│   ├── embedding_service.py          # ベクトル埋め込み処理
│   ├── chat_service.py               # チャット/LLM機能
│   ├── summary_service.py            # 要約機能
│   └── analytics_service.py          # 分析サービス
├── models/
│   ├── __init__.py
│   └── state.py                      # アプリケーション状態管理
└── pages/
    └── spec_explanation.py           # 機能仕様ページ（英数字のみ）
```

## 各モジュールの役割

### streamlit_app.py
- Streamlitアプリケーションのエントリーポイント
- 全体レイアウトの定義とコンポーネントの配置
- セッション状態の初期化

### config.py
- モデル名、ステージ名などの定数定義
- 環境変数からの設定読み込み
- UI設定（テーマ、色など）

### utils/ - ユーティリティ関数
- **pdf_utils.py**: PDFファイル操作（読み込み、テキスト抽出、メタデータ抽出）
- **snowflake_utils.py**: Snowflakeセッション管理、ステージ操作
- **vector_utils.py**: ベクトル類似度計算、検索ロジック
- **export_utils.py**: チャット履歴エクスポート（CSV/MD）

### components/ - UI要素
- **sidebar.py**: サイドバーのUI要素とイベントハンドラ
- **pdf_viewer.py**: PDF表示とページナビゲーション
- **search_interface.py**: 
  - 検索結果のフィルタリングと並び替え
  - 結果のプレビュー表示と強化機能
  - 検索分析情報の表示
  - PDFプレビューとブックマーク機能
- **chat_interface.py**: チャットUI、質問と回答の表示
- **analytics_panel.py**: 分析結果の可視化

### services/ - ビジネスロジック
- **embedding_service.py**: テキストのベクトル化
- **chat_service.py**: LLMを使った回答生成
- **summary_service.py**: 文書要約機能
- **analytics_service.py**: 利用・検索・トレンド分析

### models/ - データモデル
- **state.py**: アプリケーション状態管理クラス

### pages/
- **spec_explanation.py**: 機能仕様ページ（UIから遷移可能）

## 改善されたデータフロー

1. ユーザーがPDFをアップロード
2. PDF処理サービスがテキスト抽出
3. テキストは自動的にベクトル化され、Snowflakeステージに保存
4. ユーザーの質問はベクトル化され、類似文書部分を検索
5. 関連コンテキストをLLMに送信し回答を生成
6. 結果をUIに表示、履歴を保存

## アーキテクチャ制約

### UI制約
- レスポンシブデザインは実装しない
- ダークモードは実装しない
- シンプルで直感的なインターフェースを維持する
- 検索モードは明確に区別できるUIを提供する

### パフォーマンス制約
- 検索結果の表示は最適化（ページネーション）
- プレビュー表示の遅延読み込み
- 分析情報の非同期更新

## 検索機能
### 検索モード
1. 複数PDF検索モード
   - 全ドキュメントを対象とした検索
   - 高度なフィルタリング機能
   - 検索結果の統合表示

2. 個別PDF検索モード
   - 単一ドキュメントに特化した検索
   - ページ単位での検索
   - コンテキストを考慮した検索結果表示

### 検索タイプ
1. ハイブリッド検索
   - ベクトル検索とキーワード検索の組み合わせ
   - 類似語の活用
   - スコアの正規化と統合

2. ベクトル検索
   - セマンティック検索
   - 埋め込みベクトルの活用
   - 類似度に基づくランキング

3. キーワード検索
   - 完全一致検索
   - 部分一致検索
   - ブール演算子のサポート

## 検索インターフェースの機能

### 検索結果のフィルタリングと並び替え
1. フィルタリング機能
   - スコアベース（0.0-1.0）
   - ドキュメントタイプ
   - カスタムフィルター

2. 並び替え機能
   - スコア（昇順/降順）
   - マッチ数
   - ファイル名
   - 更新日時

3. ページネーション
   - 5-100件/ページ
   - ページ間ナビゲーション

### 検索結果のプレビュー表示
1. スコアベースの視覚化
   - 高スコア（緑）
   - 中スコア（オレンジ）
   - 低スコア（赤）

2. コンテキスト表示
   - マッチテキストのハイライト
   - 周辺コンテキストの表示
   - クエリと類似語の強調

3. インタラクション機能
   - PDFプレビュー
   - テキストコピー
   - ブックマーク追加

### 検索分析情報
1. 基本統計
   - 総ドキュメント数
   - 平均スコア
   - 結果数
   - 高スコア件数

2. スコア分析
   - スコア分布
   - 統計情報

3. ドキュメント分析
   - ドキュメント別統計
   - タイプ別分析

4. マッチング分析
   - 用語ランキング
   - パターン分析
   - グラフ・図表による可視化
